<?php

namespace App\Services\AI;

/**
 * AI プロンプト構築サービス
 * OpenAI、Anthropic、Gemini で共通のプロンプトを生成
 */
class PromptBuilder
{
    /**
     * 補完用プロンプトを構築
     */
    public static function buildCompletionPrompt(string $query, string $type, int $limit, string $language, array $fewShotExamples = []): string
    {
        $typeText = $type === 'brand' ? 'ブランド名' : '香水名';

        $prompt = "あなたは香水の専門エキスパートです。実在する香水製品のみを対象として、ユーザーのクエリに最も関連性の高い「ブランド名 + 香水名」の組み合わせを提案してください。

**対象範囲:** 有名ブランド（シャネル、ディオール、クリード、バイレード、エルメス、トムフォード、アミュアージュ、メゾン・マルジェラ、ディプティック、ル・ラボ、メゾン・フランシス・カーキジャン等）から真のニッチブランド（ナシマト、パルファム・ダンピール、オルファクティブ・スタジオ、エタット・リーブル・ドランジュ等）まで幅広く含める

**重要：多言語対応について**
- `text`フィールド：必ず日本語名（日本語カタカナ表記）を返す
- `text_en`フィールド：必ず英語名（オリジナル英語表記）を返す
- 両フィールドに同じ英語名を入れることは禁止
- 必ず異なる言語表記を提供する

**多言語表記の正しい例：**
- text: \"ディオール ソヴァージュ EDT\" / text_en: \"Dior Sauvage EDT\"
- text: \"シャネル No.5 オードゥパルファム\" / text_en: \"Chanel No.5 Eau de Parfum\"
- text: \"バイレード ジプシー ウォーター\" / text_en: \"Byredo Gypsy Water\"
- text: \"トム フォード ブラック オーキッド\" / text_en: \"Tom Ford Black Orchid\"
- text: \"クリード アベントゥス\" / text_en: \"Creed Aventus\"
- text: \"クリード ヒマラヤ\" / text_en: \"Creed Himalaya\"
- text: \"クリード シルバー マウンテン ウォーター\" / text_en: \"Creed Silver Mountain Water\"

**間違った多言語表記の例（禁止）：**
- text: \"Dior Sauvage EDT\" / text_en: \"Dior Sauvage EDT\" （同じ英語名は禁止）
- text: \"Chanel No.5\" / text_en: \"Chanel No.5\" （同じ表記は禁止）

**出力形式の重要な変更：**
- `text`フィールド：純粋な香水名のみ（ブランド名を除く日本語名）
- `text_en`フィールド：純粋な香水名のみ（ブランド名を除く英語名）
- `brand_name`フィールド：日本語ブランド名
- `brand_name_en`フィールド：英語ブランド名

**正しい出力例：**
```json
{
  \"text\": \"ソヴァージュ EDT\",
  \"text_en\": \"Sauvage EDT\",
  \"brand_name\": \"ディオール\",
  \"brand_name_en\": \"Dior\",
  \"confidence\": 0.9
}
```

**間違った出力例（禁止）：**
```json
{
  \"text\": \"ディオール ソヴァージュ EDT\",  // ブランド名を含むのは禁止
  \"text_en\": \"Dior Sauvage EDT\",      // ブランド名を含むのは禁止
}
```

**絶対的な制約（厳守）:**
- 香水名とブランド名を必ず分離する
- `text`と`text_en`にはブランド名を含めない
- 架空の香水や存在しない製品は提案しない
- 実在する香水ブランドの製品のみ（メジャーブランドからニッチブランドまで幅広く対象とする）
- **香水のバリエーション・コンセントレーション・フランカーを積極的に含める**

**香水バリエーション例（分離形式）:**
- 入力「Dior Sauvage」→ 分離出力:
  - text: \"ソヴァージュ EDT\", brand_name: \"ディオール\"
  - text: \"ソヴァージュ パルファム\", brand_name: \"ディオール\"
  - text: \"ソヴァージュ エリクサー\", brand_name: \"ディオール\"
- 入力「Chanel No.5」→ 分離出力:
  - text: \"No.5 オードゥパルファム\", brand_name: \"シャネル\"
  - text: \"No.5 オードゥトワレ\", brand_name: \"シャネル\"

**正しい提案例（分離形式）:**
- text: \"ジプシー ウォーター\", brand_name: \"バイレード\"（○）
- text: \"ソヴァージュ EDT\", brand_name: \"ディオール\"（○：コンセントレーション明記）
- text: \"No.5 オードゥパルファム\", brand_name: \"シャネル\"（○：フルネーム）

**間違った提案例:**
- text: \"バイレード ジプシー ウォーター\"（×：ブランド名を含む）
- text: \"ディオール ソヴァージュ\"（×：ブランド名を含む）
- brand_nameが空（×：ブランド名必須）

**Chain of Thought - 実在香水製品検索:**

**Step 1: クエリ分析**
クエリ: \"{$query}\"
- ブランド名推定: 音韻的類似性による香水ブランド特定
- 製品名推定: そのブランドの実在製品との一致度

**Step 2: 実在製品マッチング**
- 確認済み実在製品のみ抽出
- ブランド名 + 製品名の完全セット生成
- 人気度・知名度による信頼性評価

**Step 3: Few-shot参照による精度向上**";

        // Few-shot例を追加
        if (! empty($fewShotExamples)) {
            $prompt .= "\n\n**Step 3: 推論パターンの学習適用**\n以下の成功事例から推論手法を学習し、現在のクエリに適用してください:\n";
            foreach ($fewShotExamples as $i => $example) {
                $prompt .= ($i + 1).". 入力「{$example['query']}」→推論結果「{$example['selected_text']}」(精度: {$example['relevance_score']})\n";
            }
            $prompt .= "\n重要: 上記事例と全く同じブランドでなくても、推論プロセス（音韻変換、表記正規化、部分補完等）を参考にして未知のクエリを処理してください。\n";
        } else {
            $prompt .= "\n\n**Step 3: 汎用的推論能力の適用**\n";
            $prompt .= "事例がない場合でも、以下の言語学的アプローチで推論を実行:\n";
            $prompt .= "- 音韻対応ルール適用（カタカナ→英語音写の一般則）\n";
            $prompt .= "- 語彙補完技術（部分情報からの候補生成）\n";
            $prompt .= "- 表記正規化手法（音韻距離最小化）\n";
            $prompt .= "- 文脈推測（香水命名パターンからの推定）\n\n";
        }

        $prompt .= "\n\n**CRITICAL: ユーザーのクエリに関連する香水のみを提案すること**

**Task: 「ブランド名 + 香水名」の完全セットで{$limit}個の提案生成**

ユーザーのクエリ: 「{$query}」

このクエリに対して、以下の基準で{$limit}個の実在する香水製品を生成してください:

1. **最優先: クエリ関連性**: 「{$query}」と名前・音韻・コンセプトが類似している香水のみを提案
2. **完全セット必須**: 必ず「ブランド名 + 香水名」の組み合わせのみ
3. **実在性確認**: 実際に存在する香水製品のみ
4. **ブランド名単体禁止**: ブランド名だけの提案は絶対禁止
5. **重複回避必須**: 同一の「ブランド名 + 香水名」の組み合わせは絶対に重複させない
6. **バリエーション優先**: 同一香水ラインの異なるコンセントレーション・バリエーションを積極的に含める

**バリエーション提案の重要性:**
- 同じ香水ラインの異なるコンセントレーション（EDT、EDP、Parfum、Elixir等）を含める
- 限定版やフランカー製品も適宜含める

**信頼度スコア算出基準（厳密に計算）:**
以下の要素を数値化して合計し、1.0を上限とする:
- 文字列一致度: 完全一致=0.4, 部分一致=0.2, 音韻類似=0.1
- ブランド知名度: 超有名ブランド=0.3, 有名ブランド=0.2, 一般ブランド=0.1
- 製品知名度: 代表的製品=0.2, 有名製品=0.15, 一般製品=0.1
- 実在確実性: 確実に存在=0.1, 存在可能性高=0.05

**重要:** 上記の基準で各提案の信頼度スコアを厳密に計算すること。

**重要な制約:**
1. 各提案は必ず異なる「ブランド名 + 香水名」の組み合わせにする
2. 同じ組み合わせは絶対に2回提案しない
3. 必ず{$limit}個の提案を生成する（それ以上でもそれ以下でもない）

このタスクを実行し、suggest_fragrances ツールを使用して結果を返してください。";

        return $prompt;
    }

    /**
     * 正規化用プロンプトを構築
     */
    public static function buildNormalizationPrompt(string $brandName, string $fragranceName, string $language): string
    {
        return "あなたは香水データベースの専門家です。入力されたブランド名と香水名を正規化してください。

**入力:**
- ブランド名: \"{$brandName}\"
- 香水名: \"{$fragranceName}\"
- 言語: {$language}

**タスク:**
1. ブランド名を正規化（正式な表記に統一）
2. 香水名を正規化（正式な表記に統一）
3. 日本語・英語の両方の表記を提供
4. 信頼度スコアを算出（0.0-1.0）

**重要:**
- 実在するブランド・香水のみを対象とする
- 架空のブランド・香水は提案しない
- 不確実な場合は信頼度を低くする

normalize_fragrance ツールを使用して結果を返してください。";
    }
}
